<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>æŒ‘æˆ˜ä»»åŠ¡ç®¡ç†</title>

    <style>
        * {
            transition: none !important;
            animation: none !important;
        }
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 2000;

            min-width: 240px;
            max-width: 420px;
            padding: 14px 18px;

            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;

            background: #ffffff;
            color: #344054;
            border: 1px solid #e4e7ec;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);

            opacity: 0;
            transform: translateY(-8px);
            transition: all 0.25s ease;

            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            border-left: 4px solid #12B76A;
        }

        .toast.error {
            border-left: 4px solid #F04438;
        }
        .tool-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;

            height: 32px;
            padding: 0 14px;
            margin-left: 12px;

            font-size: 13px;
            font-weight: 350;

            color: #475467;
            background: #f8fafc;

            border: 1px solid #e4e7ec;
            border-radius: 999px;

            cursor: pointer;
            user-select: none;
        }

        .tool-pill:hover {
            background: #eef4ff;
            border-color: #c7d7fe;
            color: #2F6FD4;
        }

        .tool-upload {
            cursor: pointer;
        }

        body {
            background: #f5f7fb;
            font-family: "Inter", "PingFang SC", "Microsoft YaHei", sans-serif;
            padding: 20px;
        }

        .card {
            background: #fff;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            padding: 12px;
            border-top: 1px solid #eee;
            text-align: left;
        }

        th {
            background: #f0f4fa;
            font-weight: 600;
        }

        tr:hover td {
            background: #f9fbff;
        }

        input[type="text"], select {
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #d0d5dd;
            margin-right: 10px;
        }

        .btn-search, .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        /* ===== å¼¹çª— ===== */
        .modal-mask {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .modal {
            background: #fff;
            width: 720px;
            padding: 28px;
            border-radius: 16px;
            position: relative;
        }

        .modal h3 {
            text-align: center;
            color: #2F6FD4;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 20px;
            cursor: pointer;
            border: none;
            background: none;
        }

        .modal-form label {
            font-weight: 600;
            margin-top: 12px;
            display: block;
        }

        .modal-input, .modal-textarea {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            border-radius: 8px;
            border: 1px solid #d0d5dd;
        }

        .modal-textarea {
            height: 120px;
        }

        .modal-actions {
            text-align: right;
            margin-top: 16px;
        }

        .btn-primary {
            background: #2F6FD4;
            color: #fff;
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .pagination a, .pagination span {
            padding: 6px 12px;
            border-radius: 6px;
            background: #f2f5fa;
            text-decoration: none;
            color: #555;
        }

        .pagination .active {
            background: #2F6FD4;
            color: #fff;
        }
    </style>

    <script>
        function openAddModal() {
            document.getElementById("modalTitle").innerText = "æ–°å¢æŒ‘æˆ˜ä»»åŠ¡";
            document.getElementById("taskForm").reset();
            document.getElementById("taskId").value = "";
            document.getElementById("modal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("modal").style.display = "none";
        }

        function editTask(id) {
            fetch("/challenge/get/" + id)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("modalTitle").innerText = "ç¼–è¾‘æŒ‘æˆ˜ä»»åŠ¡";
                    document.getElementById("taskId").value = data.id;
                    document.getElementById("type").value = data.type;
                    document.getElementById("days").value = data.days;
                    document.getElementById("amountMin").value = data.amountMin;
                    document.getElementById("amountMax").value = data.amountMax;
                    document.getElementById("content").value = data.content;
                    document.getElementById("contentEn").value = data.contentEn;
                    document.getElementById("modal").style.display = "flex";
                });
        }
    </script>
    <script>
        function importChallengeExcel(input) {
            if (!input.files || input.files.length === 0) {
                return;
            }

            const file = input.files[0];

            if (!file.name.endsWith(".xlsx")) {
                showToast("è¯·ä¸Šä¼  .xlsx æ–‡ä»¶", "error");
                input.value = "";
                return;
            }

            const formData = new FormData();
            formData.append("file", file);

            fetch("/challenge/import", {
                method: "POST",
                body: formData
            })
                .then(res => res.text())
                .then(msg => {
                    showToast(msg, "success");
                    setTimeout(() => location.reload(), 2000);
                })
                .catch(() => {
                    showToast("å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", "error");
                })
                .finally(() => {
                    input.value = "";
                });
        }
    </script>

    <script>
        function showToast(message, type) {
            const toast = document.getElementById("toast");
            if (!toast) return;

            toast.textContent = message;
            toast.className = "toast show " + (type || "success");

            setTimeout(() => {
                toast.classList.remove("show");
            }, 2200);
        }
    </script>
</head>

<section layout:fragment="content">

    <!-- ğŸ” æœç´¢ -->
    <form class="card" th:action="@{/challenge/list}" method="get">
        <label>å†…å®¹æœç´¢ï¼š</label>
        <input type="text" name="contentKeyword" th:value="${contentKeyword}" />

        <label>ç±»å‹ï¼š</label>
        <select name="type">
            <option value="">å…¨éƒ¨</option>
            <option value="1" th:selected="${type == 1}">ç´¯è®¡</option>
            <option value="2" th:selected="${type == 2}">è¿ç»­</option>
        </select>

        <button class="btn-search" type="submit">ğŸ”</button>

        <button type="button"
                class="btn-icon"
                onclick="openAddModal()"
                >â•</button>

        <label class="tool-pill tool-upload">
            å¯¼å…¥æ•°æ®
            <input type="file"
                   accept=".xlsx"
                   onchange="importChallengeExcel(this)"
                   hidden />
        </label>

        <button type="button"
                class="tool-pill"
                onclick="window.location.href='/challenge/exportTemplate'">
            ä¸‹è½½æ¨¡æ¿
        </button>
    </form>

    <!-- ğŸ“‹ è¡¨æ ¼ -->
    <div class="card">
        <table>
            <tr>
                <th>ç±»å‹</th>
                <th>ä¸‹é™</th>
                <th>ä¸Šé™</th>
                <th>å¤©æ•°</th>
                <th>ä¸­æ–‡å†…å®¹</th>
                <th>è‹±æ–‡å†…å®¹</th>
                <th>æ“ä½œ</th>
            </tr>

            <tr th:each="t : ${pageData.records}">
                <td th:switch="${t.type}">
                    <span th:case="1">ç´¯è®¡</span>
                    <span th:case="2">è¿ç»­</span>
                </td>
                <td th:text="${t.amountMin}"></td>
                <td th:text="${t.amountMax}"></td>
                <td th:text="${t.days}"></td>
                <td th:text="${#strings.abbreviate(t.content, 100)}"></td>
                <td th:text="${#strings.abbreviate(t.contentEn, 100)}"></td>
                <td>
                    <a href="javascript:void(0)" th:onclick="editTask([[${t.id}]])">ç¼–è¾‘</a>
                    |
                    <a th:href="@{/challenge/delete(id=${t.id})}"
                       onclick="return confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')">åˆ é™¤</a>
                </td>
            </tr>
        </table>
    </div>

    <!-- ğŸ“„ åˆ†é¡µ -->
    <div class="pagination">
        <a th:if="${pageData.current > 1}"
           th:href="@{/challenge/list(page=${pageData.current-1}, contentKeyword=${contentKeyword}, type=${type})}">
            ä¸Šä¸€é¡µ
        </a>

        <span th:each="i : ${#numbers.sequence(1, pageData.pages)}">
            <span th:if="${i == pageData.current}" th:text="${i}" class="active"></span>
            <a th:if="${i != pageData.current}"
               th:text="${i}"
               th:href="@{/challenge/list(page=${i}, contentKeyword=${contentKeyword}, type=${type})}">
            </a>
        </span>

        <a th:if="${pageData.current < pageData.pages}"
           th:href="@{/challenge/list(page=${pageData.current+1}, contentKeyword=${contentKeyword}, type=${type})}">
            ä¸‹ä¸€é¡µ
        </a>
    </div>

    <!-- âœ¨ å¼¹çª— -->
    <div id="modal" class="modal-mask" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">

            <button class="modal-close" onclick="closeModal()">Ã—</button>
            <h3 id="modalTitle">æ–°å¢æŒ‘æˆ˜ä»»åŠ¡</h3>

            <form id="taskForm" class="modal-form" th:action="@{/challenge/save}" method="post">

                <input type="hidden" id="taskId" name="id"/>

                <label>æŒ‘æˆ˜ç±»å‹</label>
                <select id="type" name="type" class="modal-input">
                    <option value="1">ç´¯è®¡</option>
                    <option value="2">è¿ç»­</option>
                </select>

                <label>æœ€å°å€¼</label>
                <input id="amountMin" name="amountMin" class="modal-input" required/>

                <label>æœ€å¤§å€¼</label>
                <input id="amountMax" name="amountMax" class="modal-input" required/>

                <label>å¤©æ•°</label>
                <input id="days" name="days" class="modal-input" required/>

                <label>ä¸­æ–‡å†…å®¹</label>
                <textarea id="content" name="content" class="modal-textarea" required></textarea>

                <label>è‹±æ–‡å†…å®¹</label>
                <textarea id="contentEn" name="contentEn" class="modal-textarea" required></textarea>

                <div class="modal-actions">
                    <button type="submit" class="btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Toast æç¤º -->
    <div id="toast" class="toast"></div>
</section>
</html>
